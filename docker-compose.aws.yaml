services:
  web:
    image: ${ECR_REGISTRY}/claire-web:latest
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL}
      - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
    depends_on:
      - api
    networks:
      - claire
    restart: always

  api:
    image: ${ECR_REGISTRY}/claire-api:latest
    ports:
      - "8000:8000"
    environment:
      - BACKEND_PROJECT_NAME=${BACKEND_PROJECT_NAME}
      - BACKEND_API_V1_STR=${BACKEND_API_V1_STR}
      - BACKEND_API_VERSION=${BACKEND_API_VERSION}
      - BACKEND_API_ENVIRONMENT=${BACKEND_API_ENVIRONMENT}
      - BACKEND_API_DESCRIPTION=${BACKEND_API_DESCRIPTION}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_POOL_SIZE=${POSTGRES_POOL_SIZE}
      - POSTGRES_MAX_OVERFLOW=${POSTGRES_MAX_OVERFLOW}
      - MINIO_ENDPOINT=minio:9000
      - MINIO_SECURE=false
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME}
      - LOG_LEVEL=${LOG_LEVEL}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
      - CLERK_PUBLISHABLE_KEY=${CLERK_PUBLISHABLE_KEY}
      - CLERK_JWKS_URL=${CLERK_JWKS_URL}
    depends_on:
      - db
      - minio
      - createbuckets
    networks:
      - claire
    restart: always

  db:
    image: ${ECR_REGISTRY}/claire-db:latest
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always
    networks:
      - claire

  minio:
    image: quay.io/minio/minio:RELEASE.2025-04-22T22-12-26Z-cpuv1
    command: ["server", "--console-address", ":9001", "/data"]
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    restart: always
    networks:
      - claire

  createbuckets:
    image: minio/mc:RELEASE.2025-07-16T15-35-03Z-cpuv1
    depends_on:
      - minio
    entrypoint:
      [
        "/bin/sh",
        "-c",
        "tr -d '\\r' < /create-bucket.sh > /tmp/script.sh && /bin/sh /tmp/script.sh",
      ]
    volumes:
      - ./scripts/create-bucket.sh:/create-bucket.sh
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME}
    restart: on-failure
    networks:
      - claire

networks:
  claire:
    driver: bridge

volumes:
  postgres_data:
  minio_data:
